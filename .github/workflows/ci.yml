name: CI - Security & Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ============================================================================
  # SAST - Static Application Security Testing
  # ============================================================================
  sast-backend:
    name: SAST - Backend (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd backend
          pip install bandit[toml] safety

      - name: Run Bandit (SAST)
        run: |
          cd backend
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ -ll -f txt

      - name: Upload Bandit Report
        uses: actions/upload-artifact@v3
        with:
          name: bandit-report
          path: backend/bandit-report.json

      - name: Check for critical vulnerabilities
        run: |
          cd backend
          if bandit -r app/ -ll -f txt | grep -i "Severity: High"; then
            echo "âŒ Critical vulnerabilities found!"
            exit 1
          fi

  sast-frontend:
    name: SAST - Frontend (JavaScript)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run ESLint Security
        run: |
          cd frontend
          npm run lint

  # ============================================================================
  # SCA - Software Composition Analysis
  # ============================================================================
  sca-backend:
    name: SCA - Backend Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Safety
        run: pip install safety

      - name: Run Safety Check
        run: |
          cd backend
          safety check --json > safety-report.json || true
          safety check

      - name: Upload Safety Report
        uses: actions/upload-artifact@v3
        with:
          name: safety-report
          path: backend/safety-report.json

  sca-frontend:
    name: SCA - Frontend Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run npm audit
        run: |
          cd frontend
          npm audit --audit-level=moderate

  # ============================================================================
  # Secret Scanning
  # ============================================================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for TruffleHog

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # ============================================================================
  # Container Scanning
  # ============================================================================
  container-scan-backend:
    name: Container Scan - Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Backend Image
        run: |
          cd backend
          docker build -t secureshare-backend:${{ github.sha }} .

      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: secureshare-backend:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-backend-results.sarif'

  container-scan-frontend:
    name: Container Scan - Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Frontend Image
        run: |
          cd frontend
          docker build -t secureshare-frontend:${{ github.sha }} .

      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: secureshare-frontend:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-frontend-results.sarif'

  # ============================================================================
  # Unit Tests
  # ============================================================================
  test-backend:
    name: Unit Tests - Backend
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run Tests with Coverage
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
        run: |
          cd backend
          pytest --cov=app --cov-report=xml --cov-report=html --cov-report=term

      - name: Upload Coverage Reports
        uses: codecov/codecov-action@v3
        with:
          file: backend/coverage.xml
          flags: backend
          name: backend-coverage

      - name: Coverage Threshold Check
        run: |
          cd backend
          coverage report --fail-under=80

  test-frontend:
    name: Unit Tests - Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run Tests with Coverage
        run: |
          cd frontend
          npm run test:coverage

      - name: Upload Coverage Reports
        uses: codecov/codecov-action@v3
        with:
          directory: frontend/coverage
          flags: frontend
          name: frontend-coverage

  # ============================================================================
  # Build Verification
  # ============================================================================
  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [sast-backend, sast-frontend, sca-backend, sca-frontend, secret-scan]
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Compose
        run: |
          docker-compose build --no-cache

      - name: Start Services
        run: |
          docker-compose up -d
          sleep 30  # Wait for services to be ready

      - name: Health Check
        run: |
          curl -f http://localhost:8000/health || exit 1
          curl -f http://localhost:3000/health || exit 1

      - name: Stop Services
        if: always()
        run: docker-compose down -v

  # ============================================================================
  # Security Summary
  # ============================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [sast-backend, sast-frontend, sca-backend, sca-frontend, secret-scan, container-scan-backend, container-scan-frontend]
    if: always()
    steps:
      - name: Security Gate Check
        run: |
          echo "ðŸ”’ Security Checks Summary:"
          echo "âœ… SAST (Backend & Frontend)"
          echo "âœ… SCA (Dependency Scanning)"
          echo "âœ… Secret Scanning"
          echo "âœ… Container Scanning"
          echo ""
          echo "All security gates passed! âœ¨"
