<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SecureShare ‚Äì Pipeline CI/CD Live</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Palette Premium Dark Mode */
      --bg-main: #050505;
      --bg-card: rgba(255, 255, 255, 0.03);
      --bg-card-hover: rgba(255, 255, 255, 0.05);
      --border-color: rgba(255, 255, 255, 0.08);
      
      --text-main: #ededed;
      --text-muted: #a1a1aa;
      --text-faint: #71717a;
      
      /* Couleurs d'accentuation vibrantes */
      --color-success: #10b981; /* Emerald */
      --color-success-bg: rgba(16, 185, 129, 0.1);
      --color-failure: #f43f5e; /* Rose */
      --color-failure-bg: rgba(244, 63, 94, 0.1);
      --color-running: #f59e0b; /* Amber */
      --color-running-bg: rgba(245, 158, 11, 0.1);
      --color-accent: #3b82f6; /* Blue */
      --color-accent-bg: rgba(59, 130, 246, 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg-main);
      background-image: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
      font-family: 'Inter', system-ui, sans-serif;
      color: var(--text-main);
      min-height: 100vh;
      padding: 40px 20px;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 40px;
    }
    .logo {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, #10b981, #059669);
      border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px;
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    header h1 { font-size: 22px; font-weight: 600; letter-spacing: -0.5px; }
    header p  { font-size: 13px; color: var(--text-muted); margin-top: 4px; font-weight: 400; }
    
    .refresh-btn {
      margin-left: auto;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-main);
      padding: 10px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: flex; align-items: center; gap: 8px;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }
    .refresh-btn:hover { 
      background: var(--bg-card-hover); 
      border-color: rgba(255, 255, 255, 0.2);
    }
    .spin { animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ RUN BANNER (Glassmorphism) ‚îÄ‚îÄ */
    .run-banner {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 40px;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }
    /* Subtle glow line at the top of the banner */
    .run-banner::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    }

    .run-status-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .dot-success { background: var(--color-success); box-shadow: 0 0 12px var(--color-success); }
    .dot-failure { background: var(--color-failure); box-shadow: 0 0 12px var(--color-failure); }
    .dot-running { background: var(--color-running); box-shadow: 0 0 12px var(--color-running); animation: pulse 2s infinite; }
    .dot-pending { background: var(--text-faint); }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.4;} }

    .run-title   { font-weight: 600; font-size: 16px; margin-bottom: 6px; }
    .run-meta    { font-size: 13px; color: var(--text-muted); }
    .run-meta strong { color: var(--text-main); font-weight: 500; }
    
    .run-badge   { 
      margin-left: auto; padding: 6px 14px; border-radius: 8px; 
      font-size: 12px; font-weight: 600; text-decoration: none; 
      transition: all 0.2s; border: 1px solid transparent;
    }
    .run-badge:hover { filter: brightness(1.2); }
    .badge-success { background: var(--color-success-bg); color: var(--color-success); border-color: rgba(16, 185, 129, 0.2); }
    .badge-failure { background: var(--color-failure-bg); color: var(--color-failure); border-color: rgba(244, 63, 94, 0.2); }
    .badge-running { background: var(--color-running-bg); color: var(--color-running); border-color: rgba(245, 158, 11, 0.2); }

    /* ‚îÄ‚îÄ PHASES ‚îÄ‚îÄ */
    .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .phase-label {
      font-size: 11px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 2px; color: var(--text-faint); margin-bottom: 16px; margin-top: 40px;
      display: flex; align-items: center; gap: 12px;
    }
    .phase-label::after {
      content: ''; flex: 1; height: 1px; background: var(--border-color);
    }
    .phase-label:first-of-type { margin-top: 0; }

    .jobs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    /* ‚îÄ‚îÄ JOB CARD ‚îÄ‚îÄ */
    .job-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
      position: relative;
    }
    .job-card:hover { 
      background: var(--bg-card-hover);
      border-color: rgba(255, 255, 255, 0.15); 
      transform: translateY(-2px); 
    }
    
    /* Ligne de couleur en haut de la carte selon le statut */
    .job-card::before {
      content: ''; position: absolute; top: -1px; left: 16px; right: 16px; height: 2px; border-radius: 2px; opacity: 0.8;
    }
    .job-card.success::before { background: var(--color-success); box-shadow: 0 2px 10px var(--color-success); }
    .job-card.failure::before { background: var(--color-failure); box-shadow: 0 2px 10px var(--color-failure); }
    .job-card.running::before { background: var(--color-running); box-shadow: 0 2px 10px var(--color-running); }
    .job-card.skipped { opacity: 0.5; filter: grayscale(1); }

    .jc-header { display: flex; align-items: center; gap: 14px; }
    .jc-icon { 
      font-size: 18px; flex-shrink: 0; 
      background: rgba(255,255,255,0.05); 
      width: 38px; height: 38px; 
      display: flex; align-items: center; justify-content: center; 
      border-radius: 10px; border: 1px solid rgba(255,255,255,0.05);
    }
    .jc-name { font-size: 14px; font-weight: 500; color: var(--text-main); margin-bottom: 4px; }
    .jc-dur  { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 6px;}

    .jc-tags { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag {
      font-size: 11px; padding: 4px 10px; border-radius: 6px;
      font-weight: 500; border: 1px solid transparent;
    }
    .tag.green  { background: var(--color-success-bg); color: var(--color-success); border-color: rgba(16, 185, 129, 0.2); }
    .tag.blue   { background: var(--color-accent-bg); color: var(--color-accent); border-color: rgba(59, 130, 246, 0.2); }
    .tag.purple { background: rgba(168, 85, 247, 0.1); color: #c084fc; border-color: rgba(168, 85, 247, 0.2); }
    .tag.orange { background: var(--color-running-bg); color: var(--color-running); border-color: rgba(245, 158, 11, 0.2); }
    .tag.red    { background: var(--color-failure-bg); color: var(--color-failure); border-color: rgba(244, 63, 94, 0.2); }
    .tag.gray   { background: rgba(255, 255, 255, 0.05); color: var(--text-muted); border-color: var(--border-color); }

    /* ‚îÄ‚îÄ SUMMARY DASHBOARD ‚îÄ‚îÄ */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-top: 48px;
    }
    .s-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }
    .s-card::after {
      content: ''; position: absolute; right: -20px; bottom: -20px; width: 80px; height: 80px;
      background: radial-gradient(circle, currentColor 0%, transparent 70%); opacity: 0.05; border-radius: 50%;
    }
    .s-val  { font-size: 32px; font-weight: 600; letter-spacing: -1px; line-height: 1; }
    .s-lbl  { font-size: 12px; color: var(--text-muted); font-weight: 500; }

    /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.03) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 12px;
    }
    @keyframes shimmer { to { background-position: -200% 0; } }

    .error-box {
      background: var(--color-failure-bg); border: 1px solid rgba(244, 63, 94, 0.3); border-radius: 16px;
      padding: 24px; color: var(--color-failure); font-size: 14px;
    }

    footer {
      margin-top: 60px; font-size: 12px; color: var(--text-faint);
      display: flex; justify-content: space-between;
      border-top: 1px solid var(--border-color);
      padding-top: 24px;
    }

    @media (max-width: 768px) {
      body { padding: 20px; }
      header { flex-direction: column; align-items: flex-start; gap: 16px; }
      .refresh-btn { margin-left: 0; width: 100%; justify-content: center; }
      .run-banner { flex-direction: column; align-items: flex-start; }
      .run-badge { margin-left: 0; width: 100%; text-align: center; }
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <div class="logo">üîê</div>
    <div>
      <h1>DevSecOps Pipeline</h1>
      <p id="subtitle">Initialisation de l'environnement...</p>
    </div>
    <button class="refresh-btn" onclick="load()">
      <span id="refresh-icon">‚Üª</span> Actualiser
    </button>
  </header>

  <div id="run-banner"></div>
  <div id="content">
    <div class="skeleton" style="height:120px; margin-bottom:20px"></div>
    <div class="skeleton" style="height:250px"></div>
  </div>
  <div id="summary-bar"></div>

  <footer>
    <span>SecureShare &mdash; Projet Fil Rouge &mdash; 2026</span>
    <span id="last-update"></span>
  </footer>
</div>

<script>
const OWNER = 'yohanhebrard';
const REPO  = 'securiterdanslesprojet';
const WORKFLOW = 'ci.yml';

const JOB_META = {
  'Backend Tests':        { tags: [['pytest','blue'],['33 tests','gray'],['70% cov','gray']], icon: 'üß™' },
  'Backend Security Scan':{ tags: [['Bandit','purple'],['Safety','purple'],['Semgrep','purple']], icon: 'üõ°Ô∏è' },
  'Frontend Tests':       { tags: [['Vite build','blue'],['React 18','gray']], icon: '‚öõÔ∏è' },
  'Frontend Security Scan':{ tags: [['ESLint Sec','purple'],['npm audit','purple']], icon: 'üõ°Ô∏è' },
  'Secret Scanning':      { tags: [['TruffleHog','orange']], icon: 'üîë' },
  'Docker Build & Scan':  { tags: [['Trivy','orange'],['multi-stage','gray']], icon: 'üê≥' },
  'Security Summary':     { tags: [['7 outils','green']], icon: 'üìä' },
  'Push Docker Images':   { tags: [['ghcr.io','blue']], icon: 'üì¶' },
  'Deploy to Staging':    { tags: [['staging','orange']], icon: 'üöÄ' },
  'Deploy to Production': { tags: [['production','green'],['master','blue']], icon: 'üåê' },
  'Send Notifications':   { tags: [['Slack','gray']], icon: 'üîî' },
};

const PHASES = [
  { label: 'Phase 1 ‚Äì Int√©gration Continue (CI)', jobs: ['Backend Tests','Backend Security Scan','Frontend Tests','Frontend Security Scan','Secret Scanning'] },
  { label: 'Phase 2 ‚Äì Build & Container Scan',     jobs: ['Docker Build & Scan','Security Summary'] },
  { label: 'Phase 3 ‚Äì D√©ploiement Continu (CD)',   jobs: ['Push Docker Images','Deploy to Staging','Deploy to Production','Send Notifications'] },
];

function conclusionClass(c, s) {
  if (s === 'in_progress' || s === 'queued') return 'running';
  if (c === 'success') return 'success';
  if (c === 'failure' || c === 'timed_out') return 'failure';
  if (c === 'skipped' || c === 'cancelled') return 'skipped';
  return 'pending';
}

function fmtDuration(start, end) {
  if (!start) return '';
  const s = Math.round((new Date(end || Date.now()) - new Date(start)) / 1000);
  if (s < 60) return `${s}s`;
  return `${Math.floor(s/60)}m ${s%60}s`;
}

function fmtDate(d) {
  return new Date(d).toLocaleString('fr-FR', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
}

async function load() {
  const icon = document.getElementById('refresh-icon');
  icon.classList.add('spin');

  try {
    const runsRes = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW}/runs?per_page=1`,
      { headers: { 'Accept': 'application/vnd.github+json' } }
    );
    if (!runsRes.ok) throw new Error(`Erreur API GitHub (${runsRes.status}).`);
    const runsData = await runsRes.json();
    const run = runsData.workflow_runs?.[0];
    if (!run) throw new Error('Aucun run trouv√©.');

    const jobsRes = await fetch(run.jobs_url, { headers: { 'Accept': 'application/vnd.github+json' } });
    const jobsData = await jobsRes.json();
    const jobs = jobsData.jobs || [];

    renderBanner(run);
    renderJobs(jobs, run);
    renderSummary(run, jobs);

    document.getElementById('subtitle').innerHTML = 
      `D√©p√¥t : <span style="color:var(--text-main); font-weight:500">${OWNER}/${REPO}</span> &nbsp;‚Ä¢&nbsp; Branche : <span style="color:var(--color-accent); font-weight:500">${run.head_branch}</span>`;
    document.getElementById('last-update').textContent =
      'Synchro : ' + new Date().toLocaleTimeString('fr-FR');

  } catch(e) {
    document.getElementById('content').innerHTML =
      `<div class="error-box">‚ùå √âchec de la connexion √† GitHub.<br><br><strong>${e.message}</strong></div>`;
    document.getElementById('run-banner').innerHTML = '';
  } finally {
    icon.classList.remove('spin');
  }
}

function renderBanner(run) {
  const cls = conclusionClass(run.conclusion, run.status);
  const dot = cls === 'success' ? 'dot-success' : cls === 'failure' ? 'dot-failure' : cls === 'running' ? 'dot-running' : 'dot-pending';
  const badgeCls = cls === 'success' ? 'badge-success' : cls === 'failure' ? 'badge-failure' : 'badge-running';
  const badgeTxt = cls === 'success' ? 'D√©ploiement R√©ussi' : cls === 'failure' ? '√âchec Critique' : 'Analyse en cours...';

  document.getElementById('run-banner').innerHTML = `
    <div class="run-banner fade-in">
      <div class="run-status-dot ${dot}"></div>
      <div>
        <div class="run-title">${run.display_title || run.head_commit?.message?.split('\n')[0] || 'Pipeline CI/CD'}</div>
        <div class="run-meta">
          Ex√©cution <strong>#${run.run_number}</strong> &nbsp;¬∑&nbsp; D√©clench√©e le ${fmtDate(run.created_at)}
          &nbsp;¬∑&nbsp; ‚è± ${fmtDuration(run.created_at, run.updated_at)}
        </div>
      </div>
      <a href="${run.html_url}" target="_blank" class="run-badge ${badgeCls}">${badgeTxt}</a>
    </div>`;
}

function renderJobs(jobs, run) {
  const byName = {};
  jobs.forEach(j => byName[j.name] = j);

  let html = '';
  PHASES.forEach((phase, index) => {
    html += `<div class="fade-in" style="animation-delay: ${index * 0.1}s">
      <div class="phase-label">${phase.label}</div>
      <div class="jobs-grid">`;
    
    phase.jobs.forEach(name => {
      const j = byName[name];
      const meta = JOB_META[name] || { tags: [], icon: '‚ö°' };
      if (!j) {
        html += `<div class="job-card pending">
          <div class="jc-header">
            <span class="jc-icon">${meta.icon}</span>
            <div><div class="jc-name">${name}</div><div class="jc-dur">En attente...</div></div>
          </div></div>`;
        return;
      }
      const cls = conclusionClass(j.conclusion, j.status);
      const dur = fmtDuration(j.started_at, j.completed_at);
      const tagHtml = meta.tags.map(([t,c]) => `<span class="tag ${c}">${t}</span>`).join('');
      
      const statusTag = cls === 'failure' ? `<span class="tag red">√âchec</span>` :
                        cls === 'success' ? `<span class="tag green">Succ√®s</span>` :
                        cls === 'running' ? `<span class="tag orange">En cours</span>` : '';

      html += `<a class="job-card ${cls}" href="${j.html_url}" target="_blank">
        <div class="jc-header">
          <span class="jc-icon">${meta.icon}</span>
          <div>
            <div class="jc-name">${j.name}</div>
            <div class="jc-dur">‚è± ${dur || 'Calcul...'}</div>
          </div>
        </div>
        <div class="jc-tags">${statusTag}${tagHtml}</div>
      </a>`;
    });
    html += `</div></div>`;
  });

  document.getElementById('content').innerHTML = html;
}

function renderSummary(run, jobs) {
  const success = jobs.filter(j => j.conclusion === 'success').length;
  const total   = jobs.length;
  const failed  = jobs.filter(j => j.conclusion === 'failure').length;

  document.getElementById('summary-bar').innerHTML = `
    <div class="summary-grid fade-in" style="animation-delay: 0.3s">
      <div class="s-card" style="color: var(--color-success)">
        <span class="s-val">${success}/${total}</span>
        <span class="s-lbl" style="color: var(--text-main)">Jobs Valid√©s</span>
      </div>
      <div class="s-card" style="color: ${failed > 0 ? 'var(--color-failure)' : 'var(--text-muted)'}">
        <span class="s-val">${failed}</span>
        <span class="s-lbl" style="color: var(--text-main)">√âchecs</span>
      </div>
      <div class="s-card" style="color: var(--color-accent)">
        <span class="s-val">70%</span>
        <span class="s-lbl" style="color: var(--text-main)">Couverture Test</span>
      </div>
      <div class="s-card" style="color: var(--color-success)">
        <span class="s-val">0</span>
        <span class="s-lbl" style="color: var(--text-main)">Failles Critiques</span>
      </div>
    </div>`;
}

load();
</script>
</body>
</html>